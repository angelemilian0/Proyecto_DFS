<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard del Profesor</title>
    <link rel="stylesheet" href="/custom_styles.css">
</head>

<body>

    <!-- Encabezado -->
    <header class="main-header">
        <div class="header-left">
            <button class="menu-toggle">‚ò∞</button>
            <img src="images/escuela.png" alt="Logo" class="header-logo">
        </div>

        <div class="header-center">
            <h1 class="header-title">Escuela T√©cnica Superior</h1>
        </div>

        <div class="header-right">
            <div class="header-icons">
                <button class="header-icon">üîç</button>
                <button class="header-icon">üîî</button>
                <button class="header-icon settings">‚öôÔ∏è</button>
                <button id="btnClima">üå¶Ô∏è Consultar Clima</button>
            </div>
        </div>
    </header>

    <!-- Secci√≥n para mostrar la lista de alumnos -->
    <h1>Lista de Alumnos Registrados</h1>

    <table id="tablaUsuarios">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Email</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="listaUsuarios"></tbody>
    </table>

    <!-- Bot√≥n para registrar un nuevo alumno -->
    <button id="btnAgregarUsuario">Registrar Alumno</button>

    <!-- Secci√≥n para mostrar el clima -->
    <p id="climaInfo"></p>

    <div>
        <button id="btnAnterior" disabled>‚¨Ö Anterior</button>
        <span id="paginaActual">P√°gina 1</span>
        <button id="btnSiguiente">Siguiente ‚û°</button>
    </div>       

    <!-- Scripts -->
    <script src="logic/dashboard.js"></script>
    <script src="logic/header.js"></script>

    <script>
        // Funci√≥n asincr√≥nica para cargar la lista de usuarios
        async function cargarUsuarios() {
            try {
                const token = localStorage.getItem('token'); // Obtiene el token almacenado en localStorage
                if (!token) {
                    alert("No est√°s autenticado. Inicia sesi√≥n nuevamente.");
                    window.location.href = "login.html";
                    return;
                }

                const response = await fetch('/api/usuarios/all', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`, // Enviamos el token en la cabecera
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Error al obtener usuarios');
                }

                const data = await response.json();
                console.log("Usuarios obtenidos:", data);

                if (!Array.isArray(data.usuarios)) {
                    throw new Error("Los datos recibidos no son una lista de usuarios.");
                }

                const listaUsuarios = document.getElementById('listaUsuarios');
                listaUsuarios.innerHTML = '';

                data.usuarios.forEach(usuario => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                <td>${usuario.nombre}</td>
                <td>${usuario.email}</td>
                <td>
                    <button onclick="editarUsuario('${usuario._id}')">Editar</button>
                    <button onclick="eliminarUsuario('${usuario._id}')" style="background-color: red;">Eliminar</button>
                </td>
            `;
                    listaUsuarios.appendChild(tr);
                });

            } catch (error) {
                console.error('Error al cargar usuarios:', error);
                alert(`Error: ${error.message}`);
            }
        }

        // ‚úÖ Carga la lista de usuarios cuando la p√°gina se carga
        window.onload = cargarUsuarios;

        // Funci√≥n asincr√≥nica para editar un usuario
        async function editarUsuario(id) {
            const nuevoNombre = prompt("Ingrese el nuevo nombre:");
            const nuevoEmail = prompt("Ingrese el nuevo email:");
            const nuevaPassword = prompt("Ingrese la nueva contrase√±a (opcional):");

            if (!nuevoNombre || !nuevoEmail) {
                alert("El nombre y el email son obligatorios.");
                return;
            }

            try {
                const token = localStorage.getItem('token');

                const response = await fetch(`/api/usuarios/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nombre: nuevoNombre,
                        email: nuevoEmail,
                        password: nuevaPassword || undefined
                    })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Error al actualizar usuario');
                }

                alert('Usuario editado con √©xito');
                cargarUsuarios();

            } catch (error) {
                console.error('Error:', error);
                alert(`Error al actualizar el usuario: ${error.message}`);
            }
        }

        // Funci√≥n asincr√≥nica para eliminar usuario
        async function eliminarUsuario(id) {
            if (confirm("¬øEst√°s seguro de que deseas eliminar este usuario?")) {
                try {
                    const token = localStorage.getItem('token'); // Obtiene el token almacenado en localStorage
                    if (!token) {
                        alert("No est√°s autenticado. Inicia sesi√≥n nuevamente.");
                        window.location.href = "profesor_dashboard.html";
                        return;
                    }
                    console.log("Eliminando usuario con ID:", id);

                    const response = await fetch(`/api/usuarios/${id}`, {  // üëà Ahora est√° correctamente interpolado
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`, // Enviamos el token en la cabecera
                            'Accept': 'application/json'
                        }
                    });
                    if (response.ok) {
                        alert('Usuario eliminado con √©xito');
                        cargarUsuarios();
                    } else {
                        const data = await response.json();
                        alert(`Error: ${data.error}`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al conectarse con el servidor.');
                }
            }
        }

        /**
         * Agregar un nuevo usuario
         */
         async function agregarUsuario() {
            const nombre = prompt("Ingrese el nombre del nuevo usuario:");
            const email = prompt("Ingrese el email del nuevo usuario:");
            const password = prompt("Ingrese la contrase√±a del nuevo usuario:");

            if (!nombre || !email || !password) {
                alert("Todos los campos son obligatorios.");
                return;
            }

            try {
                const token = localStorage.getItem('token');

                const response = await fetch('/api/usuarios/register', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nombre, email, password })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Error al registrar usuario');
                }

                alert('Usuario agregado con √©xito');
                cargarUsuarios();

            } catch (error) {
                console.error('Error:', error);
                alert(`Error al registrar usuario: ${error.message}`);
            }
        }

        document.getElementById('btnAgregarUsuario').addEventListener('click', agregarUsuario);

        // Funci√≥n para consultar el clima
        document.getElementById('btnClima').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/clima');
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('climaInfo').textContent =
                        `üå§Ô∏è Ciudad: ${data.ciudad} | Temp: ${data.temperatura}¬∞C | Clima: ${data.descripcion}`;
                } else {
                    document.getElementById('climaInfo').textContent = `Error al obtener el clima: ${data.error}`;
                }
            } catch (error) {
                console.error('Error al obtener el clima:', error);
                document.getElementById('climaInfo').textContent = 'No se pudo obtener el clima.';
            }
        });

        // Funci√≥n para cerrar sesi√≥n
        // document.getElementById('cerrarSesionBtn').addEventListener('click', () => {
        //     localStorage.removeItem('token');
        //     localStorage.removeItem('role');
        //     window.location.href = 'login.html';
        // });

        // Carga inicial de usuarios
        window.onload = cargarUsuarios();

    </script>

</body>

</html>