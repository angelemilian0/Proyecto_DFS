<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard del Profesor</title>
    <link rel="stylesheet" href="custom_styles.css">
</head>
<body>

    <!-- Encabezado -->
    <header class="main-header">
        <div class="header-left">
            <button class="menu-toggle">â˜°</button>
            <img src="images/escuela.png" alt="Logo" class="header-logo">
        </div>

        <div class="header-center">
            <h1 class="header-title">Escuela TÃ©cnica Superior</h1>
        </div>

        <div class="header-right">
            <div class="header-icons">
                <button class="header-icon">ğŸ”</button>
                <button class="header-icon">ğŸ””</button>
                <button class="header-icon">âš™ï¸</button>
                <button id="cerrarSesionBtn" class="header-icon">ğŸšª Cerrar SesiÃ³n</button>
                <button id="btnClima">ğŸŒ¦ï¸ Consultar Clima</button>
            </div>
        </div>
    </header>

    <!-- SecciÃ³n para mostrar la lista de alumnos -->
    <h1>Lista de Alumnos Registrados</h1>

    <table id="tablaUsuarios">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Email</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="listaUsuarios"></tbody>
    </table>

    <!-- BotÃ³n para registrar un nuevo alumno -->
    <button id="btnAgregarUsuario">Registrar Alumno</button>

    <!-- SecciÃ³n para mostrar el clima -->
    <p id="climaInfo"></p>

    <!-- Scripts -->
    <script src="logic/dashboard.js"></script>
    <script src="logic/header.js"></script>

    <script>
        // Evento para agregar un usuario
        document.getElementById('btnAgregarUsuario').addEventListener('click', () => {
            const nombre = prompt("Ingrese el nombre del nuevo usuario:");
            const email = prompt("Ingrese el email del nuevo usuario:");
            const password = prompt("Ingrese la contraseÃ±a del nuevo usuario:");

            if (nombre && email && password) {
                agregarUsuario({ nombre, email, password });
            }
        });

        // FunciÃ³n asincrÃ³nica para agregar usuario
        async function agregarUsuario(usuario) {
            try {
                const response = await fetch('/api/usuarios/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(usuario),
                });

                if (response.ok) {
                    alert('Usuario agregado con Ã©xito');
                    cargarUsuarios();
                } else {
                    const data = await response.json();
                    alert(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al conectarse con el servidor.');
            }
        }

        // FunciÃ³n asincrÃ³nica para cargar la lista de usuarios
        async function cargarUsuarios() {
            try {
                const response = await fetch('/api/usuarios/all');
                const usuarios = await response.json();
                const listaUsuarios = document.getElementById('listaUsuarios');
                listaUsuarios.innerHTML = '';

                usuarios.forEach(usuario => {
                    const tr = document.createElement('tr');
                    const tdNombre = document.createElement('td');
                    tdNombre.textContent = usuario.nombre;
                    const tdEmail = document.createElement('td');
                    tdEmail.textContent = usuario.email;
                    const tdAcciones = document.createElement('td');

                    // BotÃ³n para editar usuario
                    const btnEditar = document.createElement('button');
                    btnEditar.textContent = 'Editar';
                    btnEditar.onclick = () => editarUsuario(usuario);

                    // BotÃ³n para eliminar usuario
                    const btnEliminar = document.createElement('button');
                    btnEliminar.textContent = 'Eliminar';
                    btnEliminar.style.backgroundColor = 'red';
                    btnEliminar.onclick = () => eliminarUsuario(usuario._id);

                    tdAcciones.appendChild(btnEditar);
                    tdAcciones.appendChild(btnEliminar);
                    tr.appendChild(tdNombre);
                    tr.appendChild(tdEmail);
                    tr.appendChild(tdAcciones);
                    listaUsuarios.appendChild(tr);
                });
            } catch (error) {
                console.error('Error al cargar usuarios:', error);
            }
        }

        // FunciÃ³n asincrÃ³nica para editar un usuario
        async function editarUsuario(usuario) {
            const nuevoNombre = prompt("Ingrese el nuevo nombre:", usuario.nombre);
            const nuevoEmail = prompt("Ingrese el nuevo email:", usuario.email);
            const nuevaPassword = prompt("Ingrese la nueva contraseÃ±a:");

            if (nuevoNombre && nuevoEmail) {
                try {
                    const response = await fetch(`/api/usuarios/${usuario._id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ nombre: nuevoNombre, email: nuevoEmail, password: nuevaPassword }),
                    });

                    if (response.ok) {
                        alert('Usuario editado con Ã©xito');
                        cargarUsuarios();
                    } else {
                        const data = await response.json();
                        alert(`Error: ${data.error}`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al conectarse con el servidor.');
                }
            }
        }

        // FunciÃ³n asincrÃ³nica para eliminar usuario
        async function eliminarUsuario(id) {
            if (confirm("Â¿EstÃ¡s seguro de que deseas eliminar este usuario?")) {
                try {
                    const response = await fetch(`/api/usuarios/${id}`, { method: 'DELETE' });

                    if (response.ok) {
                        alert('Usuario eliminado con Ã©xito');
                        cargarUsuarios();
                    } else {
                        const data = await response.json();
                        alert(`Error: ${data.error}`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al conectarse con el servidor.');
                }
            }
        }

        // FunciÃ³n para consultar el clima
        document.getElementById('btnClima').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/clima');
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('climaInfo').textContent = 
                        `ğŸŒ¤ï¸ Ciudad: ${data.ciudad} | Temp: ${data.temperatura}Â°C | Clima: ${data.descripcion}`;
                } else {
                    document.getElementById('climaInfo').textContent = `Error al obtener el clima: ${data.error}`;
                }
            } catch (error) {
                console.error('Error al obtener el clima:', error);
                document.getElementById('climaInfo').textContent = 'No se pudo obtener el clima.';
            }
        });

        // FunciÃ³n para cerrar sesiÃ³n
        document.getElementById('cerrarSesionBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            window.location.href = 'login.html';
        });

        // Carga inicial de usuarios
        window.onload = cargarUsuarios;
    </script>

</body>
</html>
