<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard del Profesor</title>
    <link rel="stylesheet" href="/custom_styles.css">
</head>

<body>

    <!-- Encabezado -->
    <header class="main-header">
        <div class="header-left">
            <button class="menu-toggle">‚ò∞</button>
            <img src="images/escuela.png" alt="Logo" class="header-logo">
        </div>

        <div class="header-center">
            <h1 class="header-title">Escuela T√©cnica Superior</h1>
        </div>

        <div class="header-right">
            <div class="header-icons">
                <button class="header-icon settings">‚öôÔ∏è</button>
                <button id="btnClima">üå¶Ô∏è</button>
            </div>
        </div>
    </header>

    <!-- Secci√≥n para mostrar la lista de alumnos -->
    <h1 class="titulo-alumnos">
        Lista de Alumnos Registrados
        <button id="btnClima" class="clima-movil">üå¶Ô∏è</button>
    </h1>

    <table id="tablaUsuarios">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Email</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="listaUsuarios"></tbody>
    </table>

    <!-- Bot√≥n para registrar un nuevo alumno -->
    <button id="btnAgregarUsuario">Registrar Alumno</button>

    <!-- Secci√≥n para mostrar el clima -->
    <p id="climaInfo"></p>

    <div>
        <button id="btnAnterior">‚¨Ö Anterior</button>
        <span id="paginaActual">P√°gina 1</span>
        <button id="btnSiguiente">Siguiente ‚û°</button>
    </div>

    <!-- Scripts -->
    <script src="logic/dashboard.js"></script>
    <script src="logic/header.js"></script>

    <script>
        // ‚úÖ Cargar usuarios cuando el DOM est√© listo
        document.addEventListener("DOMContentLoaded", () => {
            console.log("üìå Ejecutando cargarUsuarios() al inicio...");
            cargarUsuarios(1);  // ‚úÖ Asegura que la primera p√°gina cargue correctamente
        });
    </script>

    <script>

        // Funci√≥n asincr√≥nica para editar un usuario
        async function editarUsuario(id) {
            const nuevoNombre = prompt("Ingrese el nuevo nombre:");
            const nuevoEmail = prompt("Ingrese el nuevo email:");
            const nuevaPassword = prompt("Ingrese la nueva contrase√±a (opcional):");

            if (!nuevoNombre || !nuevoEmail) {
                alert("El nombre y el email son obligatorios.");
                return;
            }

            try {
                const token = localStorage.getItem('token');

                const response = await fetch(`/api/usuarios/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nombre: nuevoNombre,
                        email: nuevoEmail,
                        password: nuevaPassword || undefined
                    })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Error al actualizar usuario');
                }

                alert('Usuario editado con √©xito');
                cargarUsuarios();

            } catch (error) {
                console.error('Error:', error);
                alert(`Error al actualizar el usuario: ${error.message}`);
            }
        }

        // Funci√≥n asincr√≥nica para eliminar usuario
        async function eliminarUsuario(id) {
            if (confirm("¬øEst√°s seguro de que deseas eliminar este usuario?")) {
                try {
                    const token = localStorage.getItem('token'); // Obtiene el token almacenado en localStorage
                    if (!token) {
                        alert("No est√°s autenticado. Inicia sesi√≥n nuevamente.");
                        window.location.href = "profesor_dashboard.html";
                        return;
                    }
                    console.log("Eliminando usuario con ID:", id);

                    const response = await fetch(`/api/usuarios/${id}`, {  // üëà Ahora est√° correctamente interpolado
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`, // Enviamos el token en la cabecera
                            'Accept': 'application/json'
                        }
                    });
                    if (response.ok) {
                        alert('Usuario eliminado con √©xito');
                        cargarUsuarios();
                    } else {
                        const data = await response.json();
                        alert(`Error: ${data.error}`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al conectarse con el servidor.');
                }
            }
        }

        /**
         * Agregar un nuevo usuario
         */
        async function agregarUsuario() {
            const nombre = prompt("Ingrese el nombre del nuevo usuario:");
            const email = prompt("Ingrese el email del nuevo usuario:");
            const password = prompt("Ingrese la contrase√±a del nuevo usuario:");

            if (!nombre || !email || !password) {
                alert("Todos los campos son obligatorios.");
                return;
            }

            try {
                const token = localStorage.getItem('token');

                const response = await fetch('/api/usuarios/register', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nombre, email, password })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Error al registrar usuario');
                }

                alert('Usuario agregado con √©xito');
                cargarUsuarios();

            } catch (error) {
                console.error('Error:', error);
                alert(`Error al registrar usuario: ${error.message}`);
            }
        }

        document.getElementById('btnClima').addEventListener('click', async () => {
    try {
        // Preguntar por la ciudad antes de hacer la petici√≥n
        const ciudad = prompt("Ingresa la ciudad para consultar el clima:");
        if (!ciudad) {
            alert("Debes ingresar una ciudad.");
            return;
        }

        const response = await fetch(`/api/clima/${ciudad}`); // Enviar la ciudad en la URL
        const data = await response.json();

        if (response.ok) {
            document.getElementById('climaInfo').textContent =
                `üå§Ô∏è Ciudad: ${data.name} | Temp: ${data.main.temp}¬∞C | Clima: ${data.weather[0].description}`;
        } else {
            document.getElementById('climaInfo').textContent = `Error al obtener el clima: ${data.error}`;
        }
    } catch (error) {
        console.error('Error al obtener el clima:', error);
        document.getElementById('climaInfo').textContent = 'No se pudo obtener el clima.';
    }
});

        // Funci√≥n para cerrar sesi√≥n
        // document.getElementById('cerrarSesionBtn').addEventListener('click', () => {
        //     localStorage.removeItem('token');
        //     localStorage.removeItem('role');
        //     window.location.href = 'login.html';
        // });

    </script>

</body>

</html>