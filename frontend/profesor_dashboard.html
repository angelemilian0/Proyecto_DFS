<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard del Profesor</title>
    <link rel="stylesheet" href="/custom_styles.css">
</head>

<body>

    <!-- Encabezado -->
    <header class="main-header">
        <div class="header-left">
            <button class="menu-toggle">‚ò∞</button>
            <img src="images/escuela.png" alt="Logo" class="header-logo">
        </div>

        <div class="header-center">
            <h1 class="header-title">Escuela T√©cnica Superior</h1>
        </div>

        <div class="header-right">
            <div class="header-icons">
                <button class="header-icon">üîç</button>
                <button class="header-icon">üîî</button>
                <button class="header-icon settings">‚öôÔ∏è</button>
                <button id="btnClima">üå¶Ô∏è Consultar Clima</button>
            </div>
        </div>
    </header>

    <!-- Secci√≥n para mostrar la lista de alumnos -->
    <h1>Lista de Alumnos Registrados</h1>

    <table id="tablaUsuarios">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Email</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="listaUsuarios"></tbody>
    </table>

    <!-- Bot√≥n para registrar un nuevo alumno -->
    <button id="btnAgregarUsuario">Registrar Alumno</button>

    <!-- Secci√≥n para mostrar el clima -->
    <p id="climaInfo"></p>

    <!-- Scripts -->
    <script src="logic/dashboard.js"></script>
    <script src="logic/header.js"></script>

    <script>
        /**
         * Carga la lista de usuarios desde la API
         */
        async function cargarUsuarios() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert("No est√°s autenticado. Inicia sesi√≥n nuevamente.");
                    window.location.href = "login.html";
                    return;
                }

                const response = await fetch('/api/usuarios/all', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Error al obtener usuarios');
                }

                const data = await response.json();
                console.log("Usuarios obtenidos:", data);

                const listaUsuarios = document.getElementById('listaUsuarios');
                listaUsuarios.innerHTML = '';

                data.usuarios.forEach(usuario => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${usuario.nombre}</td>
                        <td>${usuario.email}</td>
                        <td>
                            <button onclick="editarUsuario('${usuario._id}')">Editar</button>
                            <button onclick="eliminarUsuario('${usuario._id}')" style="background-color: red;">Eliminar</button>
                        </td>
                    `;
                    listaUsuarios.appendChild(tr);
                });

            } catch (error) {
                console.error('Error al cargar usuarios:', error);
                alert(`Error: ${error.message}`);
            }
        }

        // ‚úÖ Cargar usuarios al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', cargarUsuarios);

        /**
         * Agregar un nuevo usuario
         */
        async function agregarUsuario() {
            const nombre = prompt("Ingrese el nombre del nuevo usuario:");
            const email = prompt("Ingrese el email del nuevo usuario:");
            const password = prompt("Ingrese la contrase√±a del nuevo usuario:");

            if (!nombre || !email || !password) {
                alert("Todos los campos son obligatorios.");
                return;
            }

            try {
                const token = localStorage.getItem('token');

                const response = await fetch('/api/usuarios/register', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nombre, email, password })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Error al registrar usuario');
                }

                alert('Usuario agregado con √©xito');
                cargarUsuarios();

            } catch (error) {
                console.error('Error:', error);
                alert(`Error al registrar usuario: ${error.message}`);
            }
        }

        document.getElementById('btnAgregarUsuario').addEventListener('click', agregarUsuario);

        /**
         * Editar usuario
         */
        async function editarUsuario(id) {
            const nuevoNombre = prompt("Ingrese el nuevo nombre:");
            const nuevoEmail = prompt("Ingrese el nuevo email:");
            const nuevaPassword = prompt("Ingrese la nueva contrase√±a (opcional):");

            if (!nuevoNombre || !nuevoEmail) {
                alert("El nombre y el email son obligatorios.");
                return;
            }

            try {
                const token = localStorage.getItem('token');

                const response = await fetch(`/api/usuarios/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nombre: nuevoNombre,
                        email: nuevoEmail,
                        password: nuevaPassword || undefined
                    })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Error al actualizar usuario');
                }

                alert('Usuario editado con √©xito');
                cargarUsuarios();

            } catch (error) {
                console.error('Error:', error);
                alert(`Error al actualizar el usuario: ${error.message}`);
            }
        }
    </script>

</body>

</html>
